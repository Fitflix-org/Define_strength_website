# Define Strength - Frontend-Backend Integration Guide

## Current Integration Status
- âœ… Frontend: Payment flow implemented with verification
- âš ï¸ Backend: "Order not found" error on Razorpay order creation
- ğŸ¯ Goal: Align order creation and payment flow

## API Endpoints Contract

### 1. Order Creation
```
POST /api/orders/create
Headers: Authorization: Bearer <jwt_token>
Request: {
  "shippingAddress": {
    "firstName": "string",
    "lastName": "string", 
    "address": "string",
    "city": "string",
    "state": "string",
    "zipCode": "string",
    "country": "string",
    "phone": "string"
  }
}

Expected Response: {
  "success": true,
  "data": {
    "orderId": "order_123",
    "status": "PENDING", 
    "totalAmount": 1500,
    "orderNumber": "ORD-2025-001",
    "createdAt": "2025-08-09T10:30:00Z"
  }
}
```

### 2. Razorpay Order Creation
```
POST /api/payments/create-razorpay-order
Headers: Authorization: Bearer <jwt_token>
Request: {
  "orderId": "order_123",    // Internal order ID from step 1
  "amount": 1500             // Amount in rupees (NOT paise)
}

Expected Response: {
  "success": true,
  "data": {
    "id": "order_MkL7KuRZXqJKBX",     // Razorpay order ID
    "amount": 150000,                 // Amount in paise
    "currency": "INR",
    "orderId": "order_123"            // Reference to internal order
  }
}
```

### 3. Payment Verification
```
POST /api/payments/verify-payment
Headers: Authorization: Bearer <jwt_token>
Request: {
  "razorpay_order_id": "order_MkL7KuRZXqJKBX",
  "razorpay_payment_id": "pay_MkL7KuRZXqJKBX",
  "razorpay_signature": "generated_signature",
  "order_id": "order_123"           // Internal order ID
}

Expected Response: {
  "verified": true,
  "payment_id": "pay_MkL7KuRZXqJKBX",
  "order_id": "order_123",
  "status": "success",
  "message": "Payment verified successfully"
}
```

## Current Issue Analysis

### Frontend Implementation âœ…
- Order creation: `orderService.createOrder(shippingAddress)`
- Razorpay order: `razorpayService.createOrder({ orderId, amount, currency })`
- Payment verification: `razorpayService.verifyPayment({ ... })`
- Error handling: Proper try-catch with user feedback

### Backend Requirements ğŸ”
The "Order not found or not eligible for payment" error suggests:

1. **Order Status Check**: Backend may require order status to be exactly "PENDING"
2. **User Ownership**: Backend verifies order belongs to authenticated user
3. **Order Field Names**: Backend may expect different field names
4. **Amount Format**: Backend may expect amount in paise vs rupees
5. **Time Constraints**: Orders may have expiration time

### Debugging Steps for Backend Team

```javascript
// In POST /api/payments/create-razorpay-order endpoint
console.log('ğŸ“¦ Received request:', req.body);
console.log('ğŸ‘¤ Authenticated user:', req.user.id);

// Database query debugging
const order = await Order.findOne({ 
  id: req.body.orderId,
  userId: req.user.id 
});

console.log('ğŸ” Database query result:', order);
console.log('ğŸ“Š Order status:', order?.status);
console.log('ğŸ‘¤ Order user ID:', order?.userId);
console.log('ğŸ• Order created at:', order?.createdAt);

if (!order) {
  console.log('âŒ Order not found in database');
  console.log('ğŸ” Searched for orderId:', req.body.orderId);
  console.log('ğŸ” For user:', req.user.id);
}

if (order && order.status !== 'PENDING') {
  console.log('âŒ Order status not eligible:', order.status);
}

if (order && order.userId !== req.user.id) {
  console.log('âŒ Order belongs to different user');
  console.log('ğŸ” Order user:', order.userId);
  console.log('ğŸ” Request user:', req.user.id);
}
```

## Test Data for Backend Team

```json
{
  "test_user_jwt": "Bearer eyJhbGciOiJIUzI1NiIs...",
  "test_order_data": {
    "orderId": "Generated by frontend order creation",
    "amount": 1500,
    "expected_order_status": "PENDING",
    "expected_user_id": "From JWT token"
  }
}
```

## Success Criteria

### For Backend Team:
- [ ] POST /api/orders/create returns order with status "PENDING"
- [ ] POST /api/payments/create-razorpay-order finds the order successfully
- [ ] Creates Razorpay order and returns proper response format
- [ ] POST /api/payments/verify-payment verifies signature and updates order

### For Frontend Team:
- [x] Order creation flow implemented
- [x] Razorpay integration implemented  
- [x] Payment verification implemented
- [ ] Test complete flow end-to-end

## Communication Channels

1. **Immediate Issues**: Share console logs and error responses
2. **API Changes**: Update this document with any endpoint changes
3. **Testing**: Use shared test data for consistent results
4. **Deployment**: Coordinate environment variable updates

## Next Steps

1. **Backend**: Add debugging logs and share exact error details
2. **Frontend**: Test with `/payment-flow-test` tool and share results
3. **Both**: Align on exact field names and data formats
4. **Testing**: Verify complete flow with real Razorpay credentials
